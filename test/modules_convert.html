<!--
@license
Copyright (c) 2017 Adam Stark. All rights reserved.
This code may only be used under the BSD style license found at LICENSE.txt
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, minimum-scale=1, initial-scale=1,
                   user-scalable=yes">
    <title>convert</title>
    <script src="../bower_components/web-component-tester/browser.js">
    </script>
    <link rel="import" href="../bower_components/imd/imd.html">

    <!-- Import the element to test -->
    <link rel="import" href="../convert.html">
  </head>
  <body>
    <script>
    define(['convert'], function (convert) {
      function uint8Equals(valueA, valueB) {
        var iterA = valueA[Symbol.iterator]();
        var iterB = valueB[Symbol.iterator]();
        var resA = iterA.next();
        var resB = iterB.next();
        while (!resA.done && !resB.done) {
          assert.equal(resA.value, resB.value);
          resA = iterA.next(); resB = iterB.next();
        }
        assert.equal(resA.done, resB.done);
      }

      suite('Convert tests', function () {
        test('Basic encode', function (done) {
          let converter = new convert.Utf8Encoder();
          let result = converter.convert('Hello world.');
          uint8Equals(
              result,
              [72, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 46]);
          done();
        });
        test('Surrogate pair encode', function (done) {
          let converter = new convert.Utf8Encoder();
          let result = converter.convert('😀😀😀');
          uint8Equals(
              result,
              [240, 159, 152, 128, 240, 159, 152, 128, 240, 159, 152, 128]);
          done();
        });
        test('3 byte encode', function (done) {
          let converter = new convert.Utf8Encoder();
          let result = converter.convert('ばか');
          uint8Equals(
              result,
              [227, 129, 176, 227, 129, 139]);
          done();
        })
        test('2 byte encode', function (done) {
          let converter = new convert.Utf8Encoder();
          let result = converter.convert('þɝɝΔ');
          uint8Equals(
              result,
              [195, 190, 201, 157, 201, 157, 206, 148]);
          done();
        });
        test('Basic encode/decode', (done) => {
          let passThrough = new convert.Utf8Encoder().fuse(new convert.Utf8Decoder());
          let str = 'Hello world.';
          assert.equal(passThrough.convert(str), str);
          done();
        });
        test('Surrogate pair encode/decode', (done) => {
          let passThrough = new convert.Utf8Encoder().fuse(new convert.Utf8Decoder());
          let str = '😀😀😀Hello world.';
          assert.equal(passThrough.convert(str), str);
          done();
        });
        test('3-byte encode/decode', (done) => {
          let passThrough = new convert.Utf8Encoder().fuse(new convert.Utf8Decoder());
          let str = 'ばかHello world.';
          assert.equal(passThrough.convert(str), str);
          done();
        });
        test('2 byte encode/decode', (done) => {
          let passThrough = new convert.Utf8Encoder().fuse(new convert.Utf8Decoder());
          let str = 'þɝɝΔHello world.';
          assert.equal(passThrough.convert(str), str);
          done();
        });
        test('Fails on bad decode', (done) => {
          done();
        });
      });
    });
    </script>
  </body>
</html>
